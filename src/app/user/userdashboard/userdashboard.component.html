<ngx-spinner  bdColor="rgba(0, 0, 0, 0.8)" size="medium" color="#fff" type="ball-clip-rotate" [fullScreen]="true">
  <p style="color: white">Loading...</p>
</ngx-spinner>

<ng-container *ngIf="!isMobile">
  <div class="container-xl dash-80">
    <div class="main min-500">
      <app-usernavbar></app-usernavbar>

      <div class="card card-ta dash-81">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <h2 class="py-3 booking-hi">
                <img src="assets/img/booking-history.svg" />Bookings History
              </h2>
            </div>
            <div class="col-md-8">
              <ul class="list-inline py-3 table-ul">
                <li class="list-inline-item {{statusLabel == '' ? 'active' : ''}} cursor">
                  <a (click)="getList(list.first_page_url)">All</a>
                </li>
                <li class="list-inline-item {{statusLabel == 'Completed' ? 'active' : ''}} cursor">
                  <a (click)="getList(list.first_page_url, 'Completed')"
                    >Completed</a>
                </li>
                <li class="list-inline-item {{statusLabel == 'Upcoming' ? 'active' : ''}} cursor">
                  <a (click)="getList(list.first_page_url, 'Upcoming')"
                    >Upcoming</a>
                </li>
                <li class="list-inline-item {{statusLabel == 'Cancelled' ? 'active' : ''}} cursor">
                  <a (click)="getList(list.first_page_url, 'Cancelled')"
                    >Cancelled</a>
                </li>
              </ul>
            </div>
          </div>

          <table class="table table-hover mb-0">
            <!--Table head-->
            <thead>
              <tr>
                <th scope="row">PNR</th>
                <th scope="row">Routes</th>
                <th scope="row">Bus Name</th>
                <!-- <th class="th-lg">Bus Number</th> -->
                <th class="th-lg">Booking Date</th>
                <th class="th-lg">Journey Date</th>
                <th class="th-lg">Dep Time</th>
                <!-- <th class="th-lg"><a>Fare </a></th> -->
                <th class="th-lg" style="text-align: right; width: 196px">
                  <a>Status</a>
                </th>
              </tr>
            </thead>
            <tbody *ngIf="list.data && list.data.length == 0">
              <tr>
                <td colspan="6">No record available..</td>
              </tr>
            </tbody>

            <tbody *ngIf="list.data">
              <tr *ngFor="let b of list.data">
                <th scope="row">{{ b.pnr }}</th>
                <td>{{ b.source[0].name }} to {{ b.destination[0].name }}</td>
                <td>{{ b.bus.name }} <span *ngIf="b.bus.bus_number!=null">({{ b.bus.bus_number }})</span></td>
                <!-- <td></td> -->
                <td>{{ b.created_at | date: "d MMMM , y" }}</td>
                <td>{{ b.journey_dt | date: "d MMMM , y" }}</td>
                <td>{{ b.boarding_time.slice(0, -3) }}</td>
                <!-- <td>₹ {{ b.total_fare }}/-</td> -->
                <td>
                  <a class="{{ b.booking_status }} cursor">{{
                    b.booking_status
                  }}</a>
                  <span class="span-cm">
                    <ul class="list-inline pt-1 mb-0 table-ul-sub">
                      <li class="list-inline-item">
                        <a class="cursor" (click)="viewTicket(b.pnr)">View Ticket</a>|
                      </li>

                      <li class="list-inline-item active" *ngIf="b.cancel">
                        <a class="cursor" (click)="cancelTicketTab(b.pnr, content)">Cancel</a>|
                      </li>
                      <li class="list-inline-item" *ngIf="b.review">
                        <a class="cursor" (click)="addReview(b.pnr, b.bus_id, review)">Review</a>|
                      </li>
                      <li class="list-inline-item">
                        <a class="cursor"  (click)="bookAgain(b.source[0].name, b.destination[0].name)">Book again</a>
                      </li>
                    </ul>
                  </span>
                </td>
              </tr>

              <input type="hidden" [(ngModel)]="dtconfig.minDate"  name="todayDate" id="todayDate" ngbDatepicker (click)="d.toggle()"
                #d="ngbDatepicker"/>
            </tbody>
          </table>
        </div>
      </div>
      <div class="d-flex flex-row-reverse mb-5"  *ngIf="list.links && list.data.length > 0">
        <nav class="my-1 pt-1">
          <ul class="pagination pagination-circle pg-blue mb-0">
            <li (click)="getList(list.first_page_url, statusLabel)" class="page-item {{list.current_page == 1 ? 'disabled' : ''
              }} clearfix d-none d-md-block">
              <a class="page-link">First</a>
            </li>

            <li class="page-item" *ngFor="let b of list.links; let i = index">
              <a class="page-link {{list.current_page == b.label ? 'active' : ''}}" (click)="b.url ? getList(b.url, statusLabel) : ''"
                [innerHTML]="page(b.label)"></a>
            </li>

            <li class="page-item {{list.last_page == 1 ? 'disabled' : ''}} clearfix d-none d-md-block" (click)="getList(list.last_page_url, statusLabel)"
            >
              <a class="page-link">Last</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

 

</ng-container>

<ng-template #content let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Cancellation Info</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross Click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body">
    <div class="row">
      <div class="col-md-12" style="margin: 0 auto">
        <table width="100%" cellpadding="10">
          <tbody>
            <tr>
              <td class="st-ri">Amount Paid:</td>
              <td class="st-le">₹{{ cancelInfo.totalfare }}</td>
            </tr>

            <tr>
              <td class="st-ri">Cancellation Fees:</td>
              <td class="st-le">
                ₹{{ cancelInfo.deductAmount }} (
                {{ cancelInfo.deductionPercentage }})
              </td>
            </tr>

            <tr>
              <td class="st-ri">Refund Amount:</td>
              <td class="st-le">₹{{ cancelInfo.refundAmount }}</td>
            </tr>
          </tbody>
        </table>
        <div align="center">
          <button (click)="cancel_ticket()" class="btn btn-danger proceed btn-de">
            Cancel Ticket
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>


<ng-template #review let-modal>
 

  <div class="modal-body modal-body-m0">

    <h4 class="modal-title" id="modal-basic-title">
      <strong>Add Review For (PNR : {{ pnr }}) </strong>
    </h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross Click')">
      <span aria-hidden="true">&times;</span>
    </button>

    <form class="form-horizontal" [formGroup]="reviewForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <div class="cols-sm-10 add-rev">
          <span><b>Enter Your Title (Max. 4 Words)</b></span>
          <input  type="text"  class="form-control" formControlName="title" id="title" placeholder="Enter title" maxlength="30"
          />

          <div *ngIf="submitted && f.title.errors" class="invalid-feedback">
            <div *ngIf="f.title.errors.required">Title is required</div>
          </div>
        </div>

        <div class="cols-sm-10 add-rev">
          <span><b>Enter Your Comments (Max. 500 Characters)</b></span>
          <textarea class="form-control"rows="5" formControlName="comments" id="comments"  placeholder="Enter Comments" maxlength="500"
          ></textarea>

          <div *ngIf="submitted && f.comments.errors" class="invalid-feedback">
            <div *ngIf="f.comments.errors.required">Comment is required</div>
            <!-- <div  *ngIf="f.comments.errors.pattern "> Comments  must be of 200 Characters..</div> -->
          </div>
        </div>
        <hr />
        <div class="row">
          <div class="col-md-4 rate">
            <label><b>Overall : </b></label>
            <ngb-rating [(rate)]="OverallRate" [max]="5"></ngb-rating>
            <pre>Rate: <b>{{OverallRate}}</b></pre>
          </div>

          <div class="col-md-4 rate">
            <label><b>Comfort : </b></label>
            <ngb-rating [(rate)]="ComfortRate" [max]="5"></ngb-rating>
            <pre>Rate: <b>{{ComfortRate}}</b></pre>
          </div>
          <div class="col-md-4 rate">
            <label><b>Clean : </b></label>
            <ngb-rating [(rate)]="CleanRate" [max]="5"></ngb-rating>
            <pre>Rate: <b>{{CleanRate}}</b></pre>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 rate">
            <label><b>Behaviour : </b></label>
            <ngb-rating [(rate)]="BehaviourRate" [max]="5"></ngb-rating>
            <pre>Rate: <b>{{BehaviourRate}}</b></pre>
          </div>

          <div class="col-md-4 rate">
            <label><b>Timing : </b></label>
            <ngb-rating [(rate)]="TimingRate" [max]="5"></ngb-rating>
            <pre>Rate: <b>{{TimingRate}}</b></pre>
          </div>
          <div class="col-md-4 rate"></div>
        </div>
      </div>

      <div class="form-group login-app center">
        <button type="submit" class="btn btn-success">Submit</button>
      </div>
    </form>
  </div>
</ng-template>

<ng-container *ngIf="isMobile && !MenuActive">
  <div class="mobile-mybooking-top">
    <div class="row">
            <div class="col-1 pr-0 pl-2 mob-arrow-left">
              <a routerLink="/">
                <i class="fas fa-arrow-left"></i>
              </a>  
            </div>
            <div class="col-7 pl-2 pr-2 mob-list-center">
                <h5>My Bookings</h5>
            </div>
            <div class="col-4 pl-2 pr-2">
                <div class="mobile-logo">
                    <img src="assets/img/mob-img/logo.png" />
                </div>
            </div>
        </div>  
    </div>
    <ng-template #content let-modal>
      <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Cancellation Info</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross Click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
  
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12" style="margin: 0 auto">
            <table width="100%" cellpadding="10">
              <tbody>
                <tr>
                  <td class="st-ri">Amount Paid:</td>
                  <td class="st-le">₹{{ cancelInfo.totalfare }}</td>
                </tr>
  
                <tr>
                  <td class="st-ri">Cancellation Fees:</td>
                  <td class="st-le">
                    ₹{{ cancelInfo.deductAmount }} (
                    {{ cancelInfo.deductionPercentage }})
                  </td>
                </tr>
  
                <tr>
                  <td class="st-ri">Refund Amount:</td>
                  <td class="st-le">₹{{ cancelInfo.refundAmount }}</td>
                </tr>
              </tbody>
            </table>
            <div align="center">
              <button (click)="cancel_ticket()" class="btn btn-danger proceed btn-de">
                Cancel Ticket
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template #review let-modal>
      <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">
          <strong>Add Review For (PNR : {{ pnr }}) </strong>
        </h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross Click')">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
  
      <div class="modal-body">
        <form class="form-horizontal" [formGroup]="reviewForm" (ngSubmit)="onSubmit()">
          <div class="form-group">
            <div class="cols-sm-10 add-rev">
              <span><b>Enter Your Title (Max. 4 Words)</b></span>
              <input  type="text"  class="form-control" formControlName="title" id="title" placeholder="Enter title" maxlength="30"
              />
  
              <div *ngIf="submitted && f.title.errors" class="invalid-feedback">
                <div *ngIf="f.title.errors.required">Title is required</div>
              </div>
            </div>
  
            <div class="cols-sm-10 add-rev">
              <span><b>Enter Your Comments (Max. 500 Characters)</b></span>
              <textarea class="form-control"rows="3" formControlName="comments" id="comments"  placeholder="Enter Comments" maxlength="500"
              ></textarea>
  
              <div *ngIf="submitted && f.comments.errors" class="invalid-feedback">
                <div *ngIf="f.comments.errors.required">Comment is required</div>
                <!-- <div  *ngIf="f.comments.errors.pattern "> Comments  must be of 200 Characters..</div> -->
              </div>
            </div>
            <hr />
            <div class="row">
              <div class="col-md-4 rate">
                <label><b>Overall : </b></label>
                <ngb-rating [(rate)]="OverallRate" [max]="5"></ngb-rating>
                <pre>Rate: <b>{{OverallRate}}</b></pre>
              </div>
  
              <div class="col-md-4 rate">
                <label><b>Comfort : </b></label>
                <ngb-rating [(rate)]="ComfortRate" [max]="5"></ngb-rating>
                <pre>Rate: <b>{{ComfortRate}}</b></pre>
              </div>
              <div class="col-md-4 rate">
                <label><b>Clean : </b></label>
                <ngb-rating [(rate)]="CleanRate" [max]="5"></ngb-rating>
                <pre>Rate: <b>{{CleanRate}}</b></pre>
              </div>
            </div>
  
            <div class="row">
              <div class="col-md-4 rate">
                <label><b>Behaviour : </b></label>
                <ngb-rating [(rate)]="BehaviourRate" [max]="5"></ngb-rating>
                <pre>Rate: <b>{{BehaviourRate}}</b></pre>
              </div>
  
              <div class="col-md-4 rate">
                <label><b>Timing : </b></label>
                <ngb-rating [(rate)]="TimingRate" [max]="5"></ngb-rating>
                <pre>Rate: <b>{{TimingRate}}</b></pre>
              </div>
              <div class="col-md-4 rate"></div>
            </div>
          </div>
  
          <div class="form-group login-app center">
            <button type="submit" class="btn btn-success">Submit</button>
          </div>
        </form>
      </div>
    </ng-template>

<div class="mobile-mybooking-middle">
  <div class="row">    
    <div class="col-md-8">
      <ul class="list-inline py-3 table-ul mb-0">
        <li class="list-inline-item {{statusLabel == '' ? 'active' : ''}} cursor">
          <a (click)="getList(list.first_page_url)">All</a>
        </li>
        <li class="list-inline-item {{statusLabel == 'Completed' ? 'active' : ''}} cursor">
          <a (click)="getList(list.first_page_url, 'Completed')">Completed</a>
        </li>
        <li class="list-inline-item {{statusLabel == 'Upcoming' ? 'active' : ''}} cursor">
          <a (click)="getList(list.first_page_url, 'Upcoming')">Upcoming</a>
        </li>
        <li class="list-inline-item {{statusLabel == 'Cancelled' ? 'active' : ''}} cursor">
          <a (click)="getList(list.first_page_url, 'Cancelled')">Cancelled</a>
        </li>
      </ul>
    </div>
  </div>

   <div class="mobile-ticket-box shadow" *ngFor="let b of list.data; let i=index;">      
      <div class="row mob-tkbox-top">       
        <div  class="col-6" *ngIf="b.status == 2">
          <h5 class="cancel">Cancelled</h5>         
        </div>
        <div  class="col-6" *ngIf="b.status == 1 && b.journey_dt > currentDate">         
          <h5 class="confirmed">Upcoming</h5>
        </div>
        <div  class="col-6" *ngIf="b.status == 1 && b.journey_dt < currentDate">         
          <h5 class="expired">Completed</h5>
        </div>
        <div class="col-6 text-right"><span>PNR:</span> {{ b.pnr }}</div>
      </div>

      <div class="row mob-tkbox-mid">
        <div  class="col-5 pl-3 pr-2 text-center"><h6>{{ b.source[0].name }}</h6></div>
        <div class="col-2 p-0 text-center"><i class="fas fa-arrow-right"></i></div>
        <div class="col-5 pl-2 pr-3 text-center"><h6>{{ b.destination[0].name }}</h6></div>
        <div class="col-12 p-0 text-center"> {{ b.journey_dt | date: "E, d MMM , yyy" }}</div>
      </div>

      <div class="row mob-tkbox-bot">
        <div  class="col-6"><span>Booked On</span><br/>
          {{ b.journey_dt | date: "E, d MMM , yyy" }}</div>
        <div class="col-6">
          <span>{{ b.booking_detail.length}} Seats</span><br/>          
          <span *ngFor="let bd of b.booking_detail; let bi = index">
            <span>{{ bd.bus_seats.seats.seatText }},</span>
          </span>
        </div>
      </div>
      <hr/>
      <div class="row mob-tkbox-bot">
        <input type="hidden" [(ngModel)]="dtconfig.minDate"  name="todayDate" id="todayDate" ngbDatepicker (click)="d.toggle()"
        #d="ngbDatepicker"/>
        <div  class="col-12">
          <a (click)="viewTicket(b.pnr)">View Ticket</a> |
          <span *ngIf="b.cancel">
             <a (click)="cancelTicketTab(b.pnr, content)">Cancel</a> |
          </span>
          <span *ngIf="b.review">
            <a (click)="addReview(b.pnr, b.bus_id, review)" >Review</a> |
          </span>
          <a (click)="bookAgain(b.source[0].name, b.destination[0].name)">Book Again</a>
        </div>        
      </div>
   </div>

   <!-- <div class="mobile-ticket-box shadow">      
      <div class="row mob-tkbox-top">
        <div  class="col-6"><h5 class="expired">Expired</h5></div>
        <div class="col-6 text-right"><span>PNR:</span> A14359588055</div>
      </div>

      <div class="row mob-tkbox-mid">
        <div  class="col-5 pl-3 pr-2 text-center"><h6>Bhubaneswar</h6></div>
        <div class="col-2 p-0 text-center"><i class="fas fa-arrow-right"></i></div>
        <div class="col-5 pl-2 pr-3 text-center"><h6>Rourkela</h6></div>
        <div class="col-12 p-0 text-center"> Wed, 15 Jan 2022</div>
      </div>

      <div class="row mob-tkbox-bot">
        <div  class="col-6"><span>Book On</span><br/>
        Wed, 15 Jan 2022</div>
        <div class="col-6"><span>2 Seats</span><br/>
        Sl-12, Sl-14</div>
      </div>
       <hr/>
      <div class="row mob-tkbox-bot">
        <div  class="col-12">
          <a href="#">View Ticket</a> |
          <a href="#">Review</a> |
          <a href="#">Book Again</a>
        </div>
        
      </div>
   </div>

   <div class="mobile-ticket-box shadow">
      
      <div class="row mob-tkbox-top">
        <div  class="col-6"><h5 class="confirmed">Confirmed</h5></div>
        <div class="col-6 text-right"><span>PNR:</span> A14359588055</div>
      </div>

      <div class="row mob-tkbox-mid">
        <div  class="col-5 pl-3 pr-2 text-center"><h6>Bhubaneswar</h6></div>
        <div class="col-2 p-0 text-center"><i class="fas fa-arrow-right"></i></div>
        <div class="col-5 pl-2 pr-3 text-center"><h6>Rourkela</h6></div>
        <div class="col-12 p-0 text-center"> Wed, 15 Jan 2022</div>
      </div>

      <div class="row mob-tkbox-bot">
        <div  class="col-6"><span>Book On</span><br/>
        Wed, 15 Jan 2022</div>
        <div class="col-6"><span>2 Seats</span><br/>
        Sl-12, Sl-14</div>
      </div>
       <hr/>
      <div class="row mob-tkbox-bot">
        <div  class="col-12">
          <a href="#">View Ticket</a> |
          <a href="#">Review</a> |
          <a href="#">Book Again</a>
        </div>
        
      </div>
   </div>

   <div class="mobile-ticket-box shadow">
      
      <div class="row mob-tkbox-top">
        <div  class="col-6"><h5 class="cancel">Cancel</h5></div>
        <div class="col-6 text-right"><span>PNR:</span> A14359588055</div>
      </div>

      <div class="row mob-tkbox-mid">
        <div  class="col-5 pl-3 pr-2 text-center"><h6>Bhubaneswar</h6></div>
        <div class="col-2 p-0 text-center"><i class="fas fa-arrow-right"></i></div>
        <div class="col-5 pl-2 pr-3 text-center"><h6>Rourkela</h6></div>
        <div class="col-12 p-0 text-center"> Wed, 15 Jan 2022</div>
      </div>

      <div class="row mob-tkbox-bot">
        <div  class="col-6"><span>Book On</span><br/>
        Wed, 15 Jan 2022</div>
        <div class="col-6"><span>2 Seats</span><br/>
        Sl-12, Sl-14</div>
      </div>
       <hr/>
      <div class="row mob-tkbox-bot">
        <div  class="col-12">
          <a href="#">View Ticket</a> |
          <a href="#">Review</a> |
          <a href="#">Book Again</a>
        </div>
        
      </div>
   </div> -->

</div>
</ng-container>

<ng-container *ngIf="isMobile && MenuActive">
  <div class="mobile-myaccount-top">
    <div class="row">
      <div class="col-5">
        <div class="mobile-logo">
          <img src="assets/img/mob-img/logo.png" />
        </div>
      </div>
      <div class="col-7 mob-logintx">
        <a routerLink="/login" *ngIf="!session.isLoggedIn()">
          Login / Signup
        </a>
        <a routerLink="/dashboard" *ngIf="session.isLoggedIn()"> Dashboard </a>
      </div>
    </div>
  </div>

  <div class="mobile-myaccount-middle">
    <ul class="mobile-menu">
      <li>
        <a routerLink="/manage-booking"><i class="far fa-window-restore"></i> Manage Booking</a>
      </li>
      <li>
        <a routerLink="/offers"><i class="fas fa-gifts"></i> Offers</a>
      </li>
      <li>
        <a routerLink="/operators"><i class="fas fa-bus"></i> Operators</a>
      </li>
      <li>
        <a routerLink="/routes"><i class="fas fa-map-marker-alt"></i> Routes</a>
      </li>
      <li>
        <a routerLink="/faq"><i class="fas fa-question"></i> FAQ's</a>
      </li>
      <li>
        <a routerLink="/testimonials"><i class="fa fa-star"></i> Testimonials</a>
      </li>
      <li>
        <a routerLink="/terms-conditions"><i class="fas fa-file-image"></i> Terms & Conditions</a>
      </li>
      <li>
        <a routerLink="/privacy-policy"><i class="far fa-file-powerpoint"></i> Privacy Policy</a>
      </li>
      <li>
        <a routerLink="/about-us"><i class="fas fa-info-circle"></i> About Us</a>
      </li>
      <li *ngIf="session.isLoggedIn()">
        <a routerLink="/my-reviews"><i class="fas fa-comments"></i>My Review</a>
      </li>
      <li *ngIf="session.isLoggedIn()">
        <a (click)="signOut()"><i class="fas fa-sign-out-alt"></i>Logout</a>
      </li>
    </ul>
  </div>
</ng-container>

<ng-container *ngIf="isMobile">
  <div class="mob-mtbh"></div>
  <div class="mobile-fixed-bottom">
    <div class="footer-menu row m-0 mobile-bg-danger">
      <div class="col-3 p-0 text-center">
        <a routerLink="/" class="home">
          <i class="fas fa-home"></i>
          <p class="mb-0 small">Home</p>
        </a>
      </div>
      <div class="col-3 p-0 text-center">
        <a routerLink="/dashboard" class="home active">
          <i class="fas fa-ticket-alt"></i>
          <p class="mb-0 small">My Bookings</p>
        </a>
      </div>

      <div class="col-3 p-0 text-center" *ngIf="!session.isLoggedIn()">
        <a routerLink="/login" class="home">
          <i class="fas fa-user"></i>
          <p class="mb-0 small">Login</p>
        </a>
      </div>

      <div class="col-3 p-0 text-center" *ngIf="session.isLoggedIn()">
        <a routerLink="/myaccount" class="home">
          <i class="fas fa-user"></i>
          <p class="mb-0 small">My Account</p>
        </a>
      </div>

      <div class="col-3 p-0 text-center">
        <a (click)="menu()" class="home {{activeMenu}}">
          <i class="fas fa-bars"></i>
          <p class="mb-0 small">Menu</p>
        </a>
      </div>
    </div>
  </div>
</ng-container>